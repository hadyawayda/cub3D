# ──────────────────────────────────────────────────────────────────────────────
# PROJECT DIRECTORIES
# ──────────────────────────────────────────────────────────────────────────────

SRC_DIR                 := src
LIBFT_DIR               := lib/libft
MLX_DIR                 := assets/minilibx-linux

# ──────────────────────────────────────────────────────────────────────────────
# PROJECT SETTINGS
# ──────────────────────────────────────────────────────────────────────────────

NAME                    := cub3D
CC                      := gcc
AR                      := ar rcs
CFLAGS                  := -g -O0 -Wall -Wextra -Werror -I lib -I $(LIBFT_DIR) -I $(MLX_DIR)
OBJDIR                  := objs

# ──────────────────────────────────────────────────────────────────────────────
# LIBRARIES (libft, MiniLibX)
# ──────────────────────────────────────────────────────────────────────────────

LIBFT                   := $(LIBFT_DIR)/libft.a

MLX_FLAGS               := -L $(MLX_DIR) -lmlx -lX11 -lXext -lXrender -lm

# ──────────────────────────────────────────────────────────────────────────────
# DIRECTORY LAYOUT  (group sources into logical buckets)
# ──────────────────────────────────────────────────────────────────────────────

DIR						:= $(SRC_DIR)

# ──────────────────────────────────────────────────────────────────────────────
# SOURCE FILES   (just filenames; they get prefixed later)
# ──────────────────────────────────────────────────────────────────────────────

TOP_SRCS                := main.c init.c

PARSING_SRCS            := parse.c parse_utils.c

RENDERING_SRCS          := texture.c raycast.c render.c events.c cleanup.c

# ──────────────────────────────────────────────────────────────────────────────
# PREFIX each group with its directory
# ──────────────────────────────────────────────────────────────────────────────

TOP                     := $(addprefix $(DIR)/,$(TOP_SRCS))
PARSING                 := $(addprefix $(DIR)/,$(PARSING_SRCS))
RENDERING               := $(addprefix $(DIR)/,$(RENDERING_SRCS))

# ──────────────────────────────────────────────────────────────────────────────
# ALL SOURCE FILES & OBJECTS
# ──────────────────────────────────────────────────────────────────────────────

SRCS                    := $(TOP) $(PARSING) $(RENDERING)
OBJS                    := $(patsubst %.c,$(OBJDIR)/%.o,$(SRCS))

# ──────────────────────────────────────────────────────────────────────────────
# DEFAULT TARGET
# ──────────────────────────────────────────────────────────────────────────────

all:                    $(NAME)

# ──────────────────────────────────────────────────────────────────────────────
# LINKING
# ──────────────────────────────────────────────────────────────────────────────

$(NAME):                $(OBJS) $(LIBFT)
	$(CC) $(CFLAGS) $(OBJS) $(LIBFT) $(MLX_FLAGS) -o $@

# ──────────────────────────────────────────────────────────────────────────────
# build libft automatically if missing
# ──────────────────────────────────────────────────────────────────────────────

$(LIBFT):
	$(MAKE) --no-print-directory -C $(LIBFT_DIR)

# ──────────────────────────────────────────────────────────────────────────────
# PATTERN RULE  (.c → .o)
# ──────────────────────────────────────────────────────────────────────────────

$(OBJDIR)/%.o:          %.c
	@mkdir -p $(dir $@)
	$(CC) $(CFLAGS) -c $< -o $@

# ──────────────────────────────────────────────────────────────────────────────
# CLEAN TARGETS
# ──────────────────────────────────────────────────────────────────────────────

clean:
	@rm -f $(OBJS)
	@rm -rf $(OBJDIR)
	@$(MAKE) --no-print-directory -C $(LIBFT_DIR) clean

fclean:                 clean
	@rm -f $(NAME)
	@$(MAKE) --no-print-directory -C $(LIBFT_DIR) fclean

re:                     fclean all

# ──────────────────────────────────────────────────────────────────────────────
# OPTIONAL VALGRIND / NORM TARGETS
# ──────────────────────────────────────────────────────────────────────────────

leaks:
	valgrind --leak-check=full ./$(NAME)

norm:
	norminette | grep Error || true
